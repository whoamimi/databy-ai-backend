
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gaby AI â€” Agent Window</title>
  <style>
    :root {
      --brand-color: #28BFD1;
      --brand-color-light-1: #6FE4F0;
      --brand-color-light-2: #A8F6FB;
      --brand-color-light-3: #D6FAFC;
      --brand-color-dark-1: #148A99;
      --brand-color-dark-2: #0F6C77;
      --brand-color-dark-3: #094E55;
      --bg: #021018;
      --fg: var(--brand-color-light-3);
      --error: #ff5e56;
      --warn: #ffb997;
      --success: #43e97b;

      /* === ORB CONFIGURATION === */
      --orb-size: 180px;
      --orb-base-blur: 0.5px;
      --orb-max-blur: 3px;
      --orb-scale-idle: 1;
      --orb-scale-breath: 1.08;
      --orb-scale-activity: 0.12;

      /* Glow intensities */
      --orb-glow-near: 50px;
      --orb-glow-mid: 100px;
      --orb-glow-far: 180px;
      --orb-glow-ultra: 240px;

      /* Animation timings */
      --orb-breath-duration: 5s;
      --orb-rotate-duration: 20s;
      --orb-core-shimmer-duration: 3.5s;
      --orb-core-rotate-duration: 18s;
      --orb-pulse-duration: 3s;
      --orb-pulse-rotate-slow: 15s;
      --orb-pulse-rotate-fast: 12s;

      /* Opacity ranges */
      --orb-ring-opacity-min: 0.3;
      --orb-ring-opacity-max: 0.9;
      --orb-core-opacity-min: 0.9;
      --orb-core-opacity-max: 1;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at 30% 30%, #072029 0%, #010b10 85%);
      color: var(--fg);
      font-family: "JetBrains Mono", "Courier New", monospace;
      overflow: hidden;
    }

    /* === LAYOUT === */
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    /* === ORB SECTION === */
    .orb-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      /* Ambient glow around orb area */
      background: radial-gradient(
        circle at center,
        rgba(40, 191, 209, 0.15) 0%,
        rgba(20, 138, 153, 0.08) 20%,
        rgba(9, 78, 85, 0.04) 40%,
        transparent 70%
      );
    }

    /* Orb container with soft backdrop blur */
    .orb-section::before {
      content: "";
      position: absolute;
      width: calc(var(--orb-size) * 3);
      height: calc(var(--orb-size) * 3);
      border-radius: 50%;
      background: radial-gradient(
        circle at center,
        rgba(111, 228, 240, 0.12) 0%,
        rgba(40, 191, 209, 0.08) 30%,
        rgba(20, 138, 153, 0.04) 50%,
        transparent 100%
      );
      filter: blur(40px);
      z-index: 0;
      pointer-events: none;
      animation: ambientPulse 8s ease-in-out infinite;
    }

    .orb {
      position: relative;
      width: var(--orb-size);
      height: var(--orb-size);
      border-radius: 50%;
      z-index: 1; /* Above ambient background */

      /* Activity-based properties */
      --activity: 0; /* 0..1 - dynamically updated via JS */

      /* Multi-layer radial gradient for depth */
      background:
        radial-gradient(
          circle at 35% 35%,
          rgba(255, 255, 255, 1) 0%,
          rgba(214, 250, 252, 1) 8%,
          rgba(168, 246, 251, 1) 15%,
          rgba(111, 228, 240, 0.95) 25%,
          rgba(40, 191, 209, 0.85) 40%,
          rgba(20, 138, 153, 0.65) 65%,
          rgba(9, 78, 85, 0.45) 85%,
          rgba(2, 16, 24, 0.25) 100%
        );

      /* Enhanced multi-layer glow effect */
      box-shadow:
        /* Inner glow layers */
        inset 0 0 20px rgba(255, 255, 255, 0.6),
        inset 0 0 40px rgba(214, 250, 252, 0.5),
        inset 0 0 60px rgba(168, 246, 251, 0.4),
        inset 0 0 80px rgba(40, 191, 209, 0.35),
        /* Outer glow layers */
        0 0 var(--orb-glow-near) rgba(168, 246, 251, 0.9),
        0 0 var(--orb-glow-mid) rgba(111, 228, 240, 0.8),
        0 0 var(--orb-glow-far) rgba(40, 191, 209, 0.6),
        0 0 var(--orb-glow-ultra) rgba(40, 191, 209, 0.4);

      /* Animations */
      animation:
        orbBreath var(--orb-breath-duration) ease-in-out infinite,
        orbRotate var(--orb-rotate-duration) linear infinite;

      /* Dynamic filters based on activity */
      filter:
        blur(calc(var(--orb-base-blur) + var(--activity) * (var(--orb-max-blur) - var(--orb-base-blur))))
        brightness(calc(1 + 0.5 * var(--activity)))
        saturate(calc(1 + 0.4 * var(--activity)))
        drop-shadow(0 0 20px rgba(168, 246, 251, calc(0.5 + 0.5 * var(--activity))));

      transition: filter 280ms ease, box-shadow 400ms ease;
      will-change: transform, filter, box-shadow;
      transform-style: preserve-3d;
    }

    /* Pulsating energy rings - outer layer */
    .orb::before {
      content: "";
      position: absolute;
      inset: -50%;
      border-radius: 50%;
      background:
        radial-gradient(
          circle,
          transparent 55%,
          rgba(168, 246, 251, 0.8) 58%,
          rgba(111, 228, 240, 0.6) 62%,
          rgba(40, 191, 209, 0.4) 68%,
          transparent 75%
        );
      animation:
        energyPulse var(--orb-pulse-duration) ease-out infinite,
        pulseRotate var(--orb-pulse-rotate-slow) linear infinite reverse;
      opacity: calc(var(--orb-ring-opacity-min) + (var(--orb-ring-opacity-max) - var(--orb-ring-opacity-min)) * var(--activity));
      pointer-events: none;
      mix-blend-mode: screen;
      filter: blur(2px);
    }

    /* Pulsating energy rings - middle layer */
    .orb::after {
      content: "";
      position: absolute;
      inset: -30%;
      border-radius: 50%;
      background:
        radial-gradient(
          circle,
          transparent 65%,
          rgba(214, 250, 252, 0.9) 68%,
          rgba(168, 246, 251, 0.7) 72%,
          rgba(111, 228, 240, 0.5) 78%,
          transparent 85%
        );
      animation:
        energyPulse var(--orb-pulse-duration) ease-out infinite 1.5s,
        pulseRotate var(--orb-pulse-rotate-fast) linear infinite;
      opacity: calc(0.25 + 0.7 * var(--activity));
      pointer-events: none;
      mix-blend-mode: screen;
      filter: blur(1.5px);
    }

    /* Inner glowing core */
    .orb .core {
      position: absolute;
      inset: 15%;
      border-radius: 50%;
      background: radial-gradient(
        circle at 40% 35%,
        rgba(255, 255, 255, 1) 0%,
        rgba(255, 255, 255, 0.98) 10%,
        rgba(214, 250, 252, 0.95) 22%,
        rgba(168, 246, 251, 0.88) 38%,
        rgba(111, 228, 240, 0.75) 55%,
        rgba(40, 191, 209, 0.5) 75%,
        transparent 100%
      );
      animation:
        coreShimmer var(--orb-core-shimmer-duration) ease-in-out infinite,
        coreRotate var(--orb-core-rotate-duration) linear infinite reverse;
      filter: blur(calc(2px + 2.5px * var(--activity)));
      opacity: calc(var(--orb-core-opacity-min) + (var(--orb-core-opacity-max) - var(--orb-core-opacity-min)) * var(--activity));
      mix-blend-mode: screen;
      box-shadow:
        0 0 20px rgba(255, 255, 255, 0.8),
        0 0 40px rgba(214, 250, 252, 0.6),
        inset 0 0 15px rgba(255, 255, 255, 0.9);
    }

    /* === ORB ANIMATIONS === */
    @keyframes orbBreath {
      0%, 100% {
        transform: translateZ(0) scale(calc(var(--orb-scale-idle) + var(--orb-scale-activity) * var(--activity)));
        box-shadow:
          /* Inner glow */
          inset 0 0 20px rgba(255, 255, 255, 0.5),
          inset 0 0 40px rgba(214, 250, 252, 0.4),
          inset 0 0 60px rgba(168, 246, 251, 0.35),
          inset 0 0 80px rgba(40, 191, 209, 0.3),
          /* Outer glow - idle state */
          0 0 var(--orb-glow-near) rgba(168, 246, 251, 0.8),
          0 0 var(--orb-glow-mid) rgba(111, 228, 240, 0.7),
          0 0 var(--orb-glow-far) rgba(40, 191, 209, 0.5),
          0 0 var(--orb-glow-ultra) rgba(40, 191, 209, 0.35);
      }
      50% {
        transform: translateZ(0) scale(calc(var(--orb-scale-breath) + var(--orb-scale-activity) * var(--activity)));
        box-shadow:
          /* Inner glow - breath peak */
          inset 0 0 25px rgba(255, 255, 255, 0.7),
          inset 0 0 50px rgba(214, 250, 252, 0.6),
          inset 0 0 75px rgba(168, 246, 251, 0.5),
          inset 0 0 100px rgba(40, 191, 209, 0.45),
          /* Outer glow - breath peak */
          0 0 calc(var(--orb-glow-near) * 1.5) rgba(168, 246, 251, 1),
          0 0 calc(var(--orb-glow-mid) * 1.5) rgba(111, 228, 240, 0.95),
          0 0 calc(var(--orb-glow-far) * 1.3) rgba(40, 191, 209, 0.75),
          0 0 calc(var(--orb-glow-ultra) * 1.2) rgba(40, 191, 209, 0.6);
      }
    }

    @keyframes orbRotate {
      from { transform: translateZ(0) rotateZ(0deg); }
      to { transform: translateZ(0) rotateZ(360deg); }
    }

    @keyframes pulseRotate {
      from { transform: rotate(0deg) scale(1); }
      to { transform: rotate(360deg) scale(1); }
    }

    @keyframes coreRotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes coreShimmer {
      0%, 100% {
        opacity: 0.88;
        transform: scale(1) rotate(0deg);
      }
      50% {
        opacity: 1;
        transform: scale(1.18) rotate(180deg);
      }
    }

    @keyframes energyPulse {
      0% {
        transform: scale(0.65) rotate(0deg);
        opacity: 0;
      }
      25% {
        opacity: 0.85;
      }
      100% {
        transform: scale(1.7) rotate(90deg);
        opacity: 0;
      }
    }

    @keyframes waveExpand {
      0% {
        transform: scale(0);
        opacity: 0.8;
      }
      50% {
        opacity: 0.4;
      }
      100% {
        transform: scale(2);
        opacity: 0;
      }
    }

    .status-text {
      margin-top: 2rem;
      font-size: 1.1rem;
      color: var(--brand-color-light-2);
      letter-spacing: 0.15rem;
      text-shadow: 0 0 12px var(--brand-color-light-1);
      animation: breathe 3s infinite;
      position: relative;
      z-index: 1; /* Above ambient background */
    }

    @keyframes breathe {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    /* Ambient background pulse */
    @keyframes ambientPulse {
      0%, 100% {
        opacity: 0.6;
        transform: scale(1);
      }
      50% {
        opacity: 0.85;
        transform: scale(1.1);
      }
    }

    /* === STREAM BOX === */
    .stream-box {
      position: fixed;
      top: 1rem;
      right: 1rem;
      width: 320px;
      max-height: 400px;
      background: rgba(10, 40, 50, 0.6);
      border: 1px solid rgba(111, 228, 240, 0.3);
      border-radius: 12px;
      padding: 0;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(40, 191, 209, 0.25);
      backdrop-filter: blur(15px);
      display: flex;
      flex-direction: column;
    }

    .stream-header {
      padding: 0.8rem 1rem;
      background: rgba(20, 60, 70, 0.5);
      border-bottom: 1px solid rgba(111, 228, 240, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stream-header h3 {
      font-size: 0.95rem;
      color: var(--brand-color-light-1);
    }

    .stream-controls {
      display: flex;
      gap: 0.5rem;
    }

    .stream-btn {
      background: none;
      border: 1px solid rgba(111, 228, 240, 0.3);
      color: var(--brand-color-light-2);
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .stream-btn:hover {
      background: rgba(40, 191, 209, 0.2);
      border-color: var(--brand-color);
    }


    .stream-content {
      flex: 1;
      overflow-y: auto;
      padding: 0.8rem;
      font-size: 0.8rem;
    }

    .log-line {
      margin-bottom: 0.6rem;
      opacity: 0;
      transform: translateX(-10px);
      animation: slideIn 0.3s ease forwards;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .log-line .timestamp {
      color: var(--brand-color-dark-1);
      font-size: 0.7rem;
      min-width: 60px;
      opacity: 0.7;
    }

    .log-line .content {
      flex: 1;
      word-wrap: break-word;
      line-height: 1.4;
    }

    .log-line.info .marker { color: var(--brand-color); }
    .log-line.success .marker { color: var(--success); }
    .log-line.error .marker { color: var(--error); }
    .log-line.warn .marker { color: var(--warn); }

    @keyframes slideIn {
      to { opacity: 1; transform: translateX(0); }
    }


    /* === STATUS BAR === */
    .status-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: rgba(10, 40, 50, 0.7);
      border-top: 1px solid rgba(111, 228, 240, 0.2);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
    }

    .status-info {
      display: flex;
      align-items: center;
      gap: 2rem;
      font-size: 0.85rem;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 10px var(--success);
      animation: pulse 2s infinite;
    }

    .status-dot.disconnected {
      background: var(--error);
      box-shadow: 0 0 10px var(--error);
      animation: none;
    }

    .status-dot.processing {
      background: var(--warn);
      box-shadow: 0 0 10px var(--warn);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .room-id {
      color: var(--brand-color-dark-1);
      font-size: 0.75rem;
    }

    .footer-text {
      color: var(--brand-color-light-2);
      font-size: 0.8rem;
      opacity: 0.6;
    }

    /* === SCROLLBAR === */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(10, 40, 50, 0.3); }
    ::-webkit-scrollbar-thumb {
      background: var(--brand-color-dark-1);
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover { background: var(--brand-color); }

    /* === RESPONSIVE === */
    @media (max-width: 1024px) {
      .service-panel {
        left: 1rem;
      }

      .stream-box {
        width: 280px;
        max-height: 300px;
      }

      .status-bar {
        padding: 0 1rem;
      }
    }

    @media (max-width: 768px) {
      .service-panel {
        position: fixed;
        top: auto;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        flex-direction: row;
        width: 100%;
        padding: 0 1rem;
        justify-content: center;
      }

      .service-card {
        width: 120px;
        padding: 0.8rem;
      }

      .stream-box {
        top: auto;
        bottom: 200px;
        right: 50%;
        transform: translateX(50%);
        width: 90%;
        max-width: 400px;
      }
    }

    /* Respect reduced motion preferences */
    @media (prefers-reduced-motion: reduce) {
      .orb, .orb::before, .orb::after, .orb .core {
        animation: none !important;
      }
      .orb {
        transform: translateZ(0) scale(1);
        transition: filter 200ms ease, box-shadow 300ms ease;
      }
    }
  </style>
</head>

<body>
  <!-- Main Container -->
  <div class="main-container">
    <!-- Orb Section -->
    <div class="orb-section">
      <div class="orb" id="orb">
        <div class="wave"></div>
        <div class="wave"></div>
        <div class="wave"></div>
        <div class="core"></div>
      </div>
      <div class="status-text" id="status-text">Connecting . . .</div>
    </div>
  </div>

  <!-- Stream Box -->
  <div class="stream-box">
    <div class="stream-header">
      <h3>Agent Action History</h3>
      <div class="stream-controls">
        <button class="stream-btn" id="clear-btn">Stop</button>
        <button class="stream-btn" id="pause-btn">Pause</button>
      </div>
    </div>
    <div class="stream-content" id="stream-content"></div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <div class="status-info">
      <div class="status-item">
        <div class="status-dot disconnected" id="status-dot"></div>
        <span id="status-label">Disconnected</span>
      </div>
      <div class="status-item">
        <span>Room:</span>
        <span class="room-id" id="room-id">None</span>
      </div>
      <div class="status-item">
        <span>Service:</span>
        <span id="service-label">None</span>
      </div>
    </div>
    <div class="footer-text">Gaby AI Â© 2025</div>
  </div>

  <script>
    // === CONFIGURATION ===
    const HTTP_PROTOCOL = window.location.protocol;
    const HOST = window.location.host;

    // === STATE ===
    let eventSource = null;
    let roomId = "{{ room_id }}";  // Passed from FastAPI template
    let currentService = "{{ service }}";
    let isPaused = false;
    let messageCount = 0;

    // === DOM ELEMENTS ===
  const orb = document.getElementById('orb');
    const statusText = document.getElementById('status-text');
    const statusDot = document.getElementById('status-dot');
    const statusLabel = document.getElementById('status-label');
    const roomIdLabel = document.getElementById('room-id');
    const serviceLabel = document.getElementById('service-label');
    const streamContent = document.getElementById('stream-content');
    const clearBtn = document.getElementById('clear-btn');
    const pauseBtn = document.getElementById('pause-btn');

    roomIdLabel.textContent = roomId;
    serviceLabel.textContent = currentService;

    // === HELPERS ===
    function formatTime() {
      const now = new Date();
      return now.toLocaleTimeString('en-US', { hour12: false });
    }

    function addLog(content, type = 'info') {
      if (isPaused) return;

      const logLine = document.createElement('div');
      logLine.className = `log-line ${type}`;
      logLine.innerHTML = `
        <span class="timestamp">${formatTime()}</span>
        <span class="marker">â–Ž</span>
        <span class="content">${content}</span>
      `;

      streamContent.appendChild(logLine);
      streamContent.scrollTop = streamContent.scrollHeight;

      messageCount++;
      if (streamContent.children.length > 100) {
        streamContent.removeChild(streamContent.firstChild);
      }
    }

    function updateStatus(state, label) {
      statusDot.className = `status-dot ${state}`;
      statusLabel.textContent = label;
    }

    // === STREAMING CONNECTION ===
    function connectStream() {
      // Use the correct SSE endpoint for FastAPI
      const streamUrl = `${HTTP_PROTOCOL}//${HOST}/agent/window/${roomId}/${currentService}`;
      eventSource = new EventSource(streamUrl);

      updateStatus('processing', 'Connecting...');
      statusText.textContent = 'Connecting to live stream...';
      addLog(`Connecting to ${currentService} service...`, 'info');

      eventSource.onopen = () => {
        updateStatus('', 'Connected');
        statusText.textContent = 'Agent IDLE';
        addLog(`Connected to ${currentService} stream`, 'success');
      };

      eventSource.onmessage = (event) => {
        // Directly update statusText with the latest streaming output
        statusText.textContent = event.data;
        bumpActivity(0.9);
        addLog(event.data, 'info');
      };

      eventSource.onerror = () => {
        updateStatus('disconnected', 'Disconnected');
        statusText.textContent = 'Stream disconnected';
        addLog('Stream disconnected or lost connection', 'warn');
        eventSource.close();
      };
    }

    // === UI CONTROLS ===
    clearBtn.addEventListener('click', () => {
      streamContent.innerHTML = '';
      messageCount = 0;
      addLog('Stream cleared', 'info');
    });

    pauseBtn.addEventListener('click', () => {
      isPaused = !isPaused;
      pauseBtn.textContent = isPaused ? 'Resume' : 'Pause';
      addLog(isPaused ? 'Stream paused' : 'Stream resumed', 'info');
    });

    // === SMOOTH ACTIVITY LOOP ===
    let activity = 0;
    let lastTs = performance.now();
    function bumpActivity(amount = 0.5) {
      activity = Math.min(1, activity + amount);
    }
    function rafLoop(ts) {
      const dt = Math.min(0.12, (ts - lastTs) / 1000); // clamp to avoid large jumps
      lastTs = ts;
      const decayPerSecond = 1.2; // how quickly activity falls back
      activity = Math.max(0, activity - decayPerSecond * dt);
      // Update CSS variable for smooth visual response
      orb.style.setProperty('--activity', activity.toFixed(3));
      requestAnimationFrame(rafLoop);
    }
    requestAnimationFrame(rafLoop);

    // === INIT ===
    addLog('Gaby AI initialized', 'success');
    addLog(`Room ${roomId} â€” ready to stream ${currentService}`, 'info');
    bumpActivity(0.3);
    connectStream();
  </script>
</body>
</html>